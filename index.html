<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/assets/favicon.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> <!-- Jquery-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script> <!-- Chart.js -->
  <script src="https://kit.fontawesome.com/c6249fb7d2.js" crossorigin="anonymous"></script>

  <title>SukatTown</title>
  <style>
    :root {
      --bg: #f6efef;
      --card: #ffffff;
      --muted: #667085;
      --accent-1: #6b53f5;
      --accent-2: #a34ef2;
      --nav-bg: #ffffff;
      --nav-active: rgba(107, 83, 245, 0.12);
      --max-width: 1200px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg, #f6f9fc 0%, var(--bg) 100%);
      color: #0f1724;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 28px;
    }

    .app {
      width: 100%;
      max-width: var(--max-width);
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 18px;
      align-items: start;
    }

    /* LEFT NAV */
    .left-nav {
      background: var(--nav-bg);
      border-radius: 14px;
      padding: 16px 10px;
      box-shadow: 0 6px 20px rgba(12, 18, 30, 0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      height: fit-content;
    }

    .brand {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--accent-2);
      background: linear-gradient(180deg, rgba(163, 78, 242, 0.08), rgba(107, 83, 245, 0.06));
      font-size: 14px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
      align-items: center;
    }

    .nav button {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .18s;
      color: #555;
    }

    .nav button:hover {
      transform: translateY(-4px);
      color: var(--accent-2)
    }

    .nav button.active {
      background: var(--nav-active);
      color: var(--accent-2);
      box-shadow: inset 0 0 0 1px rgba(107, 83, 245, 0.06);
    }

    .nav .spacer {
      flex: 1
    }

    /* MAIN AREA (topbar + content) */
    .main {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* TOP BAR */
    .topbar {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      border-radius: 12px;
      background: var(--card);
      box-shadow: 0 6px 18px rgba(12, 18, 30, 0.06);
    }

    /* SEARCH (centered visually) */
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .search {
      width: 720px;
      max-width: calc(100% - 120px);
      display: flex;
      align-items: center;
      background: #f9fbff;
      border-radius: 12px;
      padding: 8px 12px;
      border: 1px solid rgba(15, 23, 36, 0.04);
      box-shadow: 0 4px 14px rgba(38, 56, 72, 0.03);
      transition: all 0.5s ease-in-out;
    }

    .search:hover {
      box-shadow: 5px 8px 22px rgba(38, 56, 72, 0.13);
      transform: translateY(1px);
    }

    .search input {
      border: 0;
      outline: none;
      background: transparent;
      padding: 8px 10px;
      font-size: 15px;
      color: #0f1724;
      flex: 1;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 10px;
      border-radius: 10px;
    }

    .hello {
      font-size: 14px;
      color: var(--muted);
      text-align: right;
    }

    .hello strong {
      display: block;
      font-size: 15px;
      color: #0b1220
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(163, 78, 242, 0.16);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-badge.offline {
      background: #ffebee;
      color: #c62828;
    }

    /* GRID CONTENT: left big area (cards) + right side column */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 320px;
      gap: 20px;
      align-items: start;
    }

    /* All cards */
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(12, 18, 30, 0.06);
      transition: all 0.4s ease-in-out;
    }

    .card:hover {
      box-shadow: 0 12px 28px rgba(12, 18, 30, 0.12);
      transform: translateY(-2px);
    }

    /* Top cards like reference */
    .cards-top-three {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
      margin-bottom: 10px;
    }
    
    .cards-top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }

    .big-tile {
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      justify-content: space-between;
    }

    .consumption-tile {
      background: linear-gradient(135deg, #6b9bf6, #4f6df0);
      color: white;
    }

    .power-tile {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .tile-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }

    .bill-widget {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid rgba(46, 125, 50, 0.1);
    }

    .tile-title {
      font-weight: 700;
      font-size: 14px;
      opacity: 0.95
    }

    .tile-value {
      font-size: 32px;
      font-weight: 800;
      margin-top: 6px
    }

    .tile-sub {
      font-size: 13px;
      opacity: 0.95;
    }

    /* usage trend card */
    .usage {
      margin-top: 8px;
    }

    .mini-cards {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .mini {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      flex: 1;
      border: 1px solid rgba(15, 23, 36, 0.04);
      text-align: center;
    }

    .mini p {
      margin: 0;
      font-size: 13px;
      color: var(--muted)
    }

    .mini strong {
      display: block;
      margin-top: 6px;
      font-size: 16px
    }

    /* RIGHT SIDEBAR cards */
    .side-col {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .prediction {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pred-row {
      display: flex;
      gap: 10px;
    }

    .small-card {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(15, 23, 36, 0.03);
    }

    /* footer / notes */
    .note {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px
    }

    /* Alert notification styles */
    .alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .alert-notification {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 18px 20px;
      border-radius: 14px;
      box-shadow: 0 10px 40px rgba(238, 90, 82, 0.4);
      display: flex;
      align-items: flex-start;
      gap: 14px;
      animation: slideIn 0.4s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .alert-notification.warning {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      box-shadow: 0 10px 40px rgba(251, 191, 36, 0.4);
    }

    .alert-notification.info {
      background: linear-gradient(135deg, #6b9bf6, #4f6df0);
      box-shadow: 0 10px 40px rgba(107, 155, 246, 0.4);
    }

    .alert-icon {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 8px;
      font-size: 18px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .alert-message {
      font-size: 13px;
      opacity: 0.95;
      line-height: 1.4;
    }

    .alert-time {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .alert-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      opacity: 0.8;
      transition: opacity 0.2s;
      font-size: 20px;
      line-height: 1;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .alert-close:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .alert-notification.removing {
      animation: slideOut 0.3s ease-in forwards;
    }

    .usage-insights {
      margin-top: 16px;
    }

    .alert-notification.removing {
      animation: slideOut 0.3s ease-in forwards;
    }

    /* Alert history section */
    .alert-history {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .alert-history-item {
      background: rgba(255, 107, 107, 0.08);
      border-left: 3px solid #ff6b6b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .alert-history-item.warning {
      background: rgba(251, 191, 36, 0.08);
      border-left-color: #fbbf24;
    }

    .alert-history-item-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .alert-history-item-message {
      color: var(--muted);
      font-size: 12px;
    }

    .alert-history-item-time {
      color: var(--muted);
      font-size: 11px;
      margin-top: 4px;
    }

    /* Medium screens - show bill widget in separate row */
    @media (max-width: 1100px) {
      .cards-top-three {
        grid-template-columns: 1fr 1fr;
      }
      
      .cards-top-three .bill-widget {
        grid-column: 1 / -1; /* Make bill widget span full width */
      }
    }
    
    /* responsive */
    @media (max-width: 980px) {
      .app {
        grid-template-columns: 60px 1fr;
        gap: 12px;
      }

      .search {
        width: 100%;
        max-width: 520px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .cards-top-three {
        grid-template-columns: 1fr 1fr;
      }

      .topbar {
        grid-template-columns: 1fr;
        row-gap: 10px;
        align-items: center;
      }

      .topbar-right {
        justify-self: end;
      }

      .alert-container {
        max-width: 90%;
        right: 5%;
      }
    }

    @media (max-width:560px) {
      body {
        padding: 16px
      }

      .left-nav {
        display: none
      }

      .app {
        grid-template-columns: 1fr;
      }

      .search {
        max-width: 100%
      }

      .cards-top-three {
        grid-template-columns: 1fr;
      }

      .alert-container {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: calc(100% - 20px);
      }
    }
  </style>
</head>

<body>
  <!-- Alert notification container -->
  <div class="alert-container" id="alertContainer"></div>

  <div class="app">

    <!-- LEFT NAV -->
    <aside class="left-nav" aria-hidden="true">
      <div class="brand">EL</div>

      <div class="nav" role="navigation" aria-label="Main">
        <button class="active" title="Dashboard" aria-label="Dashboard">
          <!-- home icon -->
          <i class="fa-solid fa-house" aria-hidden="true"></i>
        </button>

        <button title="Consumption" aria-label="Consumption">
          <i class="fa-solid fa-bolt" aria-hidden="true"></i>
        </button>

        <button title="Reports" aria-label="Reports">
          <i class="fa-solid fa-chart-area" aria-hidden="true"></i>
        </button>

        <button title="Settings" aria-label="Settings">
          <i class="fa-solid fa-gear" aria-hidden="true"></i>
        </button>

        <div class="spacer" aria-hidden="true"></div>

        <button title="Help" aria-label="Help">
          <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
        </button>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">

      <!-- TOPBAR: search + profile -->
      <div class="topbar" role="banner">
        <div class="search-wrap" aria-hidden="false">
          <div style="font-weight:700;color:#10213a">SukatTown</div>
          <span class="status-badge offline" id="connectionStatus">‚óè Offline</span>
        </div>

        <div style="display:flex;align-items:center;gap:16px;justify-self:end">
          <div class="search" role="search" aria-label="Search">
            <i class="fa-brands fa-searchengin" aria-hidden="true"></i>
            <input id="topSearch" type="search" placeholder="Search anything..." aria-label="Search anything">
          </div>

          <!-- PROFILE / GREETING on upper-right -->
          <div class="topbar-right">
            <div class="profile" title="Account">
              <div class="hello">
                <span style="font-size:13px;color:var(--muted)">Hello,</span>
                <strong>New User</strong>
              </div>
              <div class="avatar" aria-hidden="true">NU</div>
            </div>
          </div>
        </div>
      </div>

      <!-- GRID: main cards + right column -->
      <div class="grid">

        <!-- LEFT: main cards -->
        <div>
          
          <!-- top three tiles in a row -->
          <div class="cards-top-three">
            <div class="card big-tile consumption-tile">
              <div style="display:flex;align-items:flex-start;justify-content:space-between">
                <div>
                  <div class="tile-title">Today's Consumption</div>
                  <div class="tile-value" id="consumptionValue">22 kWh</div>
                  <div class="tile-sub">Current usage ‚Ä¢ Real-time ESP32 data</div>
                </div>
                <div class="tile-icon">
                  <i class="fa-solid fa-bolt" aria-hidden="true"></i>
                </div>
              </div>
          
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
                <div style="font-size:13px;opacity:.95">Peak: <strong id="peakValue">35 kWh</strong></div>
                <div style="font-size:13px;opacity:.95">Avg: <strong id="avgValue">18 kWh</strong></div>
              </div>
            </div>
          
            <div class="card big-tile power-tile">
              <div style="display:flex;align-items:flex-start;justify-content:space-between">
                <div>
                  <div class="tile-title">Voltage Stability</div>
                  <div class="tile-value" id="voltageValue">230 V</div>
                  <div class="tile-sub">Nominal voltage ‚Ä¢ RMS</div>
                </div>
                <div class="tile-icon">
                  <i class="fa-solid fa-plug" aria-hidden="true"></i>
                </div>
              </div>
          
              <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:6px">
                <div style="text-align:right;font-size:13px">Frequency: <strong id="frequencyValue">60 Hz</strong></div>
                <div style="text-align:right;font-size:13px">PF: <strong id="pfValue">0.95</strong></div>
              </div>
            </div>
          
            <!-- Projected Bill Widget (Principal Only) -->
            <div class="card big-tile bill-widget" id="billWidget">
              <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px">
                <div>
                  <div class="tile-title" style="color:#0b1220">Projected Monthly Bill</div>
                  <div class="tile-value" style="color:#2e7d32" id="projectedBill">‚Ç±1,650.00</div>
                  <div class="tile-sub" style="color:var(--muted);opacity:1">Based on usage trends</div>
                </div>
                <div class="tile-icon" style="background:linear-gradient(135deg,#4caf50,#2e7d32)">
                  <i class="fa-solid fa-peso-sign" aria-hidden="true"></i>
                </div>
              </div>
          
              <div style="display:flex;justify-content:space-between;gap:8px">
                <div style="text-align:center;flex:1">
                  <div style="font-size:11px;color:var(--muted);opacity:0.9">Today</div>
                  <div style="font-weight:700;margin-top:2px;font-size:14px" id="todayCost">‚Ç±120.50</div>
                </div>
                <div style="text-align:center;flex:1">
                  <div style="font-size:11px;color:var(--muted);opacity:0.9">This Month</div>
                  <div style="font-weight:700;margin-top:2px;font-size:14px" id="monthCost">‚Ç±1,200.00</div>
                </div>
                <div style="text-align:center;flex:1">
                  <div style="font-size:11px;color:var(--muted);opacity:0.9">Days Left</div>
                  <div style="font-weight:700;margin-top:2px;font-size:14px" id="daysRemaining">15 days</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Usage trend / mini cards -->
          <div class="card usage">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">How's the consumption today?</div>
              <div style="color:var(--muted);font-size:13px">Realtime ‚Ä¢ Live Data</div>
            </div>
          
            <!-- Chart.js consumption graph -->
            <div style="margin-top:12px;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px">
              <canvas id="consumptionChart" height="96"></canvas>
            </div>
          
            <div class="mini-cards">
              <div class="mini">
                <p id="period1Label">Morning</p>
                <strong id="period1Value">5 kWh</strong>
              </div>
              <div class="mini">
                <p id="period2Label">Afternoon</p>
                <strong id="period2Value">10 kWh</strong>
              </div>
              <div class="mini">
                <p id="period3Label">Evening</p>
                <strong id="period3Value">7 kWh</strong>
              </div>
            </div>
          </div>

          <!-- AI Insights Box -->
          <div class="card usage-insights">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
              <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-size:18px">
                <i class="fa-solid fa-brain"></i>
              </div>
              <div style="flex:1">
                <div style="font-weight:700;font-size:15px">AI-Powered Insights</div>
                <div style="font-size:12px;color:var(--muted)">Pattern analysis ‚Ä¢ Smart recommendations</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div id="aiLoadingIndicator" style="display:none">
                  <div style="width:18px;height:18px;border:2px solid rgba(107,83,245,0.3);border-top-color:var(--accent-1);border-radius:50%;animation:spin 1s linear infinite"></div>
                </div>
                <span id="aiConfidence" style="font-size:12px;color:var(--accent-1);font-weight:700;padding:4px 10px;background:rgba(107,83,245,0.1);border-radius:6px">85% confidence</span>
              </div>
            </div>

            <div style="padding:16px;background:linear-gradient(135deg,rgba(107,83,245,0.06),rgba(163,78,242,0.04));border-radius:12px;border:1px solid rgba(107,83,245,0.12)">
              <!-- Pattern Detected -->
              <div style="margin-bottom:14px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:20px">üîç</span>
                  <strong style="font-size:13px;color:#0f1724">Pattern Detected:</strong>
                </div>
                <p id="aiPattern" style="margin:0;font-size:14px;line-height:1.5;color:#344054;padding-left:28px">
                  Stable consumption pattern with slight evening peaks
                </p>
              </div>

              <!-- Insight -->
              <div style="margin-bottom:14px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:20px">üí°</span>
                  <strong style="font-size:13px;color:#0f1724">Insight:</strong>
                </div>
                <p id="aiInsight" style="margin:0;font-size:14px;line-height:1.5;color:#344054;padding-left:28px">
                  Your usage is steady at 5.2 kW, close to your average of 5.5 kW. Energy efficiency is good.
                </p>
              </div>

              <!-- Recommendation -->
              <div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                  <span style="font-size:20px">‚ú®</span>
                  <strong style="font-size:13px;color:#0f1724">Recommendation:</strong>
                </div>
                <p id="aiRecommendation" style="margin:0;font-size:14px;line-height:1.5;color:#344054;padding-left:28px">
                  Maintain current usage patterns. Monitor for any unusual spikes during peak hours.
                </p>
              </div>
            </div>

            <div style="margin-top:12px;padding:10px;background:rgba(107,83,245,0.05);border-radius:8px;display:flex;align-items:center;gap:8px">
              <i class="fa-solid fa-circle-info" style="color:var(--accent-1);font-size:14px"></i>
              <span style="font-size:12px;color:var(--muted)">Insights updated every 30 seconds using pattern recognition</span>
            </div>
          </div>
          
         </div>
        <!-- RIGHT: side column -->
        <aside class="side-col">

          <div class="card small-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">Summary</div>
                <div style="color:var(--muted);font-size:13px;margin-top:6px">Total today</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:20px;font-weight:800" id="summaryEnergy">22 kWh</div>
                <div style="font-size:13px;color:var(--muted)" id="lastUpdate">Peak 6:00 PM</div>
              </div>
            </div>

            <div class="note">Based on real-time meter readings from ESP32 via Node.js backend.</div>
          </div>

          <div class="card small-card prediction">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Real-time Values</div>
              <div style="color:var(--muted);font-size:13px">Live</div>
            </div>

            <div class="pred-row">
              <div
                style="flex:1;background:#fff;border-radius:10px;padding:10px;border:1px solid rgba(15,23,36,0.03);text-align:center">
                <div style="font-size:13px;color:var(--muted)">Voltage</div>
                <div style="font-weight:800;margin-top:6px" id="sideVoltage">230 V</div>
              </div>
              <div
                style="flex:1;background:#fff;border-radius:10px;padding:10px;border:1px solid rgba(15,23,36,0.03);text-align:center">
                <div style="font-size:13px;color:var(--muted)">Current</div>
                <div style="font-weight:800;margin-top:6px" id="sideCurrent">5 A</div>
              </div>
            </div>

            <div style="margin-top:10px" class="note">Receiving live data from ESP32...</div>
          </div>


          <!-- Alert History Card -->
          <div class="card small-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Alert History</div>
              <div style="color:var(--muted);font-size:13px" id="alertCount">0 alerts</div>
            </div>
            <div class="alert-history" id="alertHistory">
              <div class="note" style="margin-top:10px;text-align:center">No alerts yet</div>
            </div>
          </div>

          <!-- Demo Alert Triggers -->
          <div class="card small-card">
            <div style="font-weight:700;margin-bottom:12px">Demo Controls</div>

            <!-- Account Type Toggle -->
            <div style="margin-bottom:16px;padding:12px;background:rgba(107,83,245,0.08);border-radius:10px">
              <div style="font-size:13px;color:var(--muted);margin-bottom:8px" class="">Account Type</div>
              <div style="display:flex;gap:8px">
                <button onclick="setAccountType('principal')" id="principalBtn" style="flex:1;padding:8px;border-radius:6px;border:2px solid var(--accent-1);background:var(--accent-1);color:white;font-weight:600;cursor:pointer;transition:all 0.2s">
                  Principal
                </button>
                <button onclick="setAccountType('non-principal')" id="nonPrincipalBtn" style="flex:1;padding:8px;border-radius:6px;border:2px solid #ddd;background:white;color:#666;font-weight:600;cursor:pointer;transition:all 0.2s">
                  Non-Principal
                </button>
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px">
              <button onclick="triggerDemoAlert('hourly')"
                style="padding: 10px; border-radius: 8px; border: none; background: linear-gradient(135deg, rgb(251, 191, 36), rgb(245, 158, 11)); color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s; transform: scale(1);"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" class="">
                ‚ö° Trigger Hourly Alert
              </button>
              <button onclick="triggerDemoAlert('daily')"
                style="padding: 10px; border-radius: 8px; border: none; background: linear-gradient(135deg, rgb(255, 107, 107), rgb(238, 90, 82)); color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s; transform: scale(1);"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" class="">
                üö® Trigger Daily Alert
              </button>
              <button onclick="triggerDemoAlert('monthly')"
                style="padding: 10px; border-radius: 8px; border: none; background: linear-gradient(135deg, rgb(163, 78, 242), rgb(107, 83, 245)); color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s; transform: scale(1);"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" class="">
                üìà Trigger Monthly Alert
              </button>
              <button onclick="triggerDemoAlert('fire')"
                style="padding: 10px; border-radius: 8px; border: none; background: linear-gradient(135deg, rgb(255, 68, 68), rgb(204, 0, 0)); color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s; transform: scale(1);"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" class="">
                üî• Trigger Fire Alert
              </button>
            </div>
            <div class="note" style="margin-top:10px">Toggle account type to see bill visibility and click buttons to
              test alert notifications</div>
          </div>

        </aside>

      </div> <!-- end grid -->
    </div> <!-- end main -->
  </div> <!-- end app -->


  <script>
    // Live data fetching from Node.js backend
    let chartInstance = null;
    let sensorHistory = [];
    const API_URL = 'https://sukattown-backend.onrender.com/api/power-data';
    const ALERT_API_URL = 'https://sukattown-backend.onrender.com/api/consumption-alerts';
    const FIRE_ALERT_API_URL = 'https://sukattown-backend.onrender.com/api/fire-alerts'; // ADD THIS
    const COST_PER_KWH = 5.5;
    let alertHistory = [];
    let lastAlertCheck = 0;

    let isPrincipalAccount = true; // Default to principal account

    // AI Insights with placeholder data
    function generateAIInsights() {
      $('#aiLoadingIndicator').show();
      
      // Simulate processing delay
      setTimeout(() => {
        if (sensorHistory.length < 5) {
          $('#aiPattern').text('Collecting more data for analysis...');
          $('#aiInsight').text('Need at least 5 data points to generate meaningful insights.');
          $('#aiRecommendation').text('Keep monitoring your energy consumption for better analysis.');
          $('#aiConfidence').text('50% confidence');
        } else {
          // Placeholder insights (we'll make this smart later)
          const patterns = [
            'Stable consumption pattern detected',
            'Slight increasing trend in usage',
            'Energy efficient consumption pattern',
            'Evening usage spike detected',
            'Morning consumption higher than average'
          ];
          
          const insights = [
            'Your current usage is within normal range for this time of day.',
            'Power consumption is 12% below your weekly average - great job!',
            'Usage patterns suggest optimal appliance scheduling.',
            'Peak demand occurs between 6-9 PM consistently.',
            'Your consumption is steady with minimal fluctuations.'
          ];
          
          const recommendations = [
            'Continue monitoring. Consider scheduling heavy appliances during off-peak hours.',
            'Excellent energy management! Maintain these efficient practices.',
            'Try to reduce consumption during peak hours (6-9 PM) for cost savings.',
            'Consider using a timer for high-power appliances to avoid simultaneous usage.',
            'Your usage is optimal. Keep up the good work!'
          ];
          
          // Randomly select (for now - we'll make this data-driven later)
          const randomIndex = Math.floor(Math.random() * patterns.length);
          
          $('#aiPattern').text(patterns[randomIndex]);
          $('#aiInsight').text(insights[randomIndex]);
          $('#aiRecommendation').text(recommendations[randomIndex]);
          $('#aiConfidence').text(Math.floor(Math.random() * 15 + 80) + '% confidence');
        }
        
        $('#aiLoadingIndicator').hide();
      }, 800); // 800ms delay to show loading animation
    }

    function setAccountType(type) {
      isPrincipalAccount = (type === 'principal');

      // Update button styles
      if (isPrincipalAccount) {
        $('#principalBtn').css({
          'background': 'var(--accent-1)',
          'color': 'white',
          'border-color': 'var(--accent-1)'
        });
        $('#nonPrincipalBtn').css({
          'background': 'white',
          'color': '#666',
          'border-color': '#ddd'
        });
      } else {
        $('#principalBtn').css({
          'background': 'white',
          'color': '#666',
          'border-color': '#ddd'
        });
        $('#nonPrincipalBtn').css({
          'background': 'var(--accent-1)',
          'color': 'white',
          'border-color': 'var(--accent-1)'
        });
      }

      // Toggle bill widget visibility with animation
      if (isPrincipalAccount) {
        $('#billWidget').slideDown(300);
      } else {
        $('#billWidget').slideUp(300);
      }
    }

    function updateBillProjection(energy) {
      if (!isPrincipalAccount) return;

      const now = new Date();
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const currentDay = now.getDate();
      const daysRemaining = daysInMonth - currentDay;

      // Calculate daily average and project for full month
      const dailyAverage = energy / currentDay;
      const projectedMonthlyConsumption = dailyAverage * daysInMonth;
      const projectedBill = projectedMonthlyConsumption * COST_PER_KWH;

      // Calculate month-to-date cost
      const monthToDateCost = energy * COST_PER_KWH;

      // Update projected bill widget
      $('#projectedBill').text('‚Ç±' + projectedBill.toFixed(2));
      $('#monthCost').text('‚Ç±' + monthToDateCost.toFixed(2));
      $('#daysRemaining').text(daysRemaining + ' days');
    }

    function fetchSensorData() {
      fetch(API_URL)
        .then(response => response.json())
        .then(data => {
          console.log('Fetched data:', data);
          updateDashboard(data);
          updateConnectionStatus(true);

          sensorHistory.push({
            timestamp: new Date(),
            power: data.power || 0,
            energy: data.energy || 0
          });

          if (sensorHistory.length > 50) {
            sensorHistory.shift();
          }

          updateChart();
          generateAIInsights(); // Generate insights when new data arrives
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          updateConnectionStatus(false);
        });
    }

    function fetchConsumptionAlerts() {
      const now = Date.now();
      if (now - lastAlertCheck < 5000) return; // Check every 5 seconds minimum

      lastAlertCheck = now;

      fetch(ALERT_API_URL)
        .then(response => response.json())
        .then(data => {
          if (data && data.period) {
            const alertId = `${data.period}-${data.timestamp}`;

            // Check if this alert was already shown
            const existingAlert = alertHistory.find(a => a.id === alertId);
            if (!existingAlert) {
              showAlert(data);
              addToAlertHistory(data, alertId);
            }
          }
        })
        .catch(error => {
          console.error('Error fetching alerts:', error);
        });
    }

    function fetchFireAlerts() {
      fetch(FIRE_ALERT_API_URL)
        .then(response => {
          if (!response.ok) {
            if (response.status === 404) {
              return null;
            }
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data && data.type) {
            const alertId = `fire-${data.timestamp}`;

            const existingAlert = alertHistory.find(a => a.id === alertId);
            if (!existingAlert) {
              showFireAlert(data);
              addFireToAlertHistory(data, alertId);
            }
          }
        })
        .catch(error => {
          // Silently handle errors
        });
    }

    function showAlert(alertData) {
      const container = $('#alertContainer');
      const alertId = `alert-${Date.now()}`;

      let title, message, icon, type;

      switch (alertData.period) {
        case 'hourly':
          title = '‚ö†Ô∏è Hourly Limit Exceeded';
          message = `Consumption: ${alertData.consumption.toFixed(2)} kWh (Limit: ${alertData.limit} kWh) - ${alertData.percentageOver}% over`;
          icon = '‚ö°';
          type = 'warning';
          break;
        case 'daily':
          title = 'üö® Daily Limit Exceeded';
          message = `Consumption: ${alertData.consumption.toFixed(2)} kWh (Limit: ${alertData.limit} kWh) - ${alertData.percentageOver}% over`;
          icon = 'üìä';
          type = '';
          break;
        case 'monthly':
          title = 'üî¥ Monthly Limit Exceeded';
          message = `Consumption: ${alertData.consumption.toFixed(2)} kWh (Limit: ${alertData.limit} kWh) - ${alertData.percentageOver}% over`;
          icon = 'üìà';
          type = 'info';
          break;
        default:
          title = 'Alert';
          message = 'Energy consumption threshold exceeded';
          icon = '‚ö†Ô∏è';
          type = 'info';
      }

      const alertHtml = `
        <div class="alert-notification ${type}" id="${alertId}">
          <div class="alert-icon">${icon}</div>
          <div class="alert-content">
            <div class="alert-title">${title}</div>
            <div class="alert-message">${message}</div>
            <div class="alert-time">${new Date().toLocaleTimeString()}</div>
          </div>
          <button class="alert-close" onclick="closeAlert('${alertId}')">√ó</button>
        </div>
      `;

      container.append(alertHtml);

      // Play sound notification (optional)
      playAlertSound();

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        closeAlert(alertId);
      }, 10000);
    }

    function showFireAlert(alertData) {
      const container = $('#alertContainer');
      const alertId = `alert-${Date.now()}`;

      let message = '';
      if (alertData.type === 'flame_and_smoke') {
        message = `‚ö†Ô∏è CRITICAL: Flame and smoke detected! Smoke level: ${alertData.smokeLevel}`;
      } else if (alertData.type === 'flame') {
        message = `üî• Flame detected!`;
      } else if (alertData.type === 'smoke') {
        message = `üí® Smoke detected! Level: ${alertData.smokeLevel} (Threshold: ${alertData.smokeThreshold})`;
      }

      const alertHtml = `
    <div class="alert-notification" id="${alertId}" style="background:linear-gradient(135deg,#ff4444,#cc0000)">
      <div class="alert-icon">üî•</div>
      <div class="alert-content">
        <div class="alert-title">üö® FIRE ALARM!</div>
        <div class="alert-message">${message}</div>
        <div class="alert-time">${new Date().toLocaleTimeString()}</div>
      </div>
      <button class="alert-close" onclick="closeAlert('${alertId}')">√ó</button>
    </div>
  `;

      container.append(alertHtml);

      // Play urgent alarm sound
      playFireAlarmSound();

      // Auto-dismiss after 15 seconds (longer for fire alerts)
      setTimeout(() => {
        closeAlert(alertId);
      }, 15000);
    }

    function playFireAlarmSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Create urgent pulsing alarm sound
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 1200; // Higher frequency for urgency
            oscillator.type = 'square'; // Harsher sound for alarm

            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
          }, i * 600);
        }
      } catch (error) {
        console.log('Audio notification not available');
      }
    }

    function addFireToAlertHistory(alertData, alertId) {
      const historyItem = {
        id: alertId,
        period: 'fire',
        type: alertData.type,
        flameDetected: alertData.flameDetected,
        smokeLevel: alertData.smokeLevel,
        timestamp: new Date()
      };

      alertHistory.unshift(historyItem);

      if (alertHistory.length > 10) {
        alertHistory.pop();
      }

      updateAlertHistory();
    }

    function closeAlert(alertId) {
      const alert = $(`#${alertId}`);
      alert.addClass('removing');
      setTimeout(() => {
        alert.remove();
      }, 300);
    }

    function addToAlertHistory(alertData, alertId) {
      const historyItem = {
        id: alertId,
        period: alertData.period,
        consumption: alertData.consumption,
        limit: alertData.limit,
        percentageOver: alertData.percentageOver,
        timestamp: new Date()
      };

      alertHistory.unshift(historyItem);

      // Keep only last 10 alerts
      if (alertHistory.length > 10) {
        alertHistory.pop();
      }

      updateAlertHistory();
    }

    function updateAlertHistory() {
      const historyContainer = $('#alertHistory');
      $('#alertCount').text(`${alertHistory.length} alert${alertHistory.length !== 1 ? 's' : ''}`);

      if (alertHistory.length === 0) {
        historyContainer.html('<div class="note" style="margin-top:10px;text-align:center">No alerts yet</div>');
        return;
      }

      let historyHtml = '';
      alertHistory.forEach(alert => {
        const typeClass = alert.period === 'hourly' ? 'warning' : '';
        const icon = alert.period === 'hourly' ? '‚ö°' : alert.period === 'daily' ? 'üìä' : 'üìà';

        historyHtml += `
          <div class="alert-history-item ${typeClass}">
            <div class="alert-history-item-title">${icon} ${alert.period.charAt(0).toUpperCase() + alert.period.slice(1)} Alert</div>
            <div class="alert-history-item-message">
              ${alert.consumption.toFixed(2)} kWh consumed (${alert.percentageOver.toFixed(1)}% over ${alert.limit} kWh limit)
            </div>
            <div class="alert-history-item-time">${alert.timestamp.toLocaleString()}</div>
          </div>
        `;
      });

      historyContainer.html(historyHtml);
    }

    function playAlertSound() {
      // Create a simple beep sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Audio notification not available');
      }
    }

    function updateDashboard(data) {
      const voltage = data.voltage || 0;
      const current = data.current || 0;
      const power = data.power || 0;
      const energy = data.energy || 0;
      const frequency = data.frequency || 0;
      const pf = data.powerFactor || 0;
      const cost = (energy * COST_PER_KWH).toFixed(2);

      // Update main tiles
      $('#consumptionValue').text(energy.toFixed(2) + ' kWh');
      $('#voltageValue').text(voltage.toFixed(1) + ' V');
      $('#frequencyValue').text(frequency.toFixed(1) + ' Hz');
      $('#pfValue').text(pf.toFixed(2));
      $('#todayCost').text('‚Ç±' + cost);

      // Update bill projection
      updateBillProjection(energy);

      // Calculate period values based on current time and sensor history
      updatePeriodValues();

      // Update side panel
      $('#summaryEnergy').text(energy.toFixed(2) + ' kWh');
      $('#sideVoltage').text(voltage.toFixed(1) + ' V');
      $('#sideCurrent').text(current.toFixed(2) + ' A');
      $('#lastUpdate').text('Updated: ' + new Date().toLocaleTimeString());
    }

    function updatePeriodValues() {
      const now = new Date();
      const hour = now.getHours();

      // Get total accumulated energy for each period
      const morningData = sensorHistory.filter(d => new Date(d.timestamp).getHours() >= 6 && new Date(d.timestamp).getHours() < 12);
      const afternoonData = sensorHistory.filter(d => new Date(d.timestamp).getHours() >= 12 && new Date(d.timestamp).getHours() < 17);
      const eveningData = sensorHistory.filter(d => new Date(d.timestamp).getHours() >= 17 && new Date(d.timestamp).getHours() < 22);

      const morningEnergy = morningData.length > 0 ? morningData[morningData.length - 1].energy || 0 : 0;
      const afternoonEnergy = afternoonData.length > 0 ? afternoonData[afternoonData.length - 1].energy || 0 : 0;
      const eveningEnergy = eveningData.length > 0 ? eveningData[eveningData.length - 1].energy || 0 : 0;

      // Update display with values
      $('#period1Label').text(hour >= 6 && hour < 12 ? 'Morning (Now)' : 'Morning');
      $('#period1Value').text(morningEnergy.toFixed(2) + ' kWh');

      $('#period2Label').text(hour >= 12 && hour < 17 ? 'Afternoon (Now)' : 'Afternoon');
      $('#period2Value').text(afternoonEnergy.toFixed(2) + ' kWh');

      $('#period3Label').text(hour >= 17 && hour < 22 ? 'Evening (Now)' : 'Evening');
      $('#period3Value').text(eveningEnergy.toFixed(2) + ' kWh');
    }

    function updateConnectionStatus(connected) {
      const badge = $('#connectionStatus');
      if (connected) {
        badge.removeClass('offline').text('‚óè Connected');
      } else {
        badge.addClass('offline').text('‚óè Offline');
      }
    }

    function updateChart() {
      if (sensorHistory.length === 0) return;

      const labels = sensorHistory.map(d => {
        const time = new Date(d.timestamp);
        return time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      });
      const powerData = sensorHistory.map(d => d.power / 1000);

      if (chartInstance) {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = powerData;
        chartInstance.update('none');
      } else {
        initChart(labels, powerData);
      }
    }


    // Chart.js integration (cannot be converted to jQuery)
    function initChart(labels, data) {
      const ctx = document.getElementById('consumptionChart').getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 0, 96);
      gradient.addColorStop(0, 'rgba(107, 83, 245, 0.3)');
      gradient.addColorStop(1, 'rgba(107, 83, 245, 0.01)');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Power (kW)',
            data: data,
            borderColor: '#6b53f5',
            backgroundColor: gradient,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#6b53f5',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#6b53f5',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(255, 255, 255, 0.98)',
              titleColor: '#0f1724',
              bodyColor: '#6b53f5',
              borderColor: 'rgba(107, 83, 245, 0.2)',
              borderWidth: 2,
              padding: 16,
              borderRadius: 12,
              titleFont: {
                size: 12,
                weight: '600',
                family: 'Inter, sans-serif'
              },
              bodyFont: {
                size: 18,
                weight: '800',
                family: 'Inter, sans-serif'
              },
              displayColors: false,
              caretSize: 8,
              caretPadding: 10,
              callbacks: {
                title: function (context) {
                  return context[0].label;
                },
                label: function (context) {
                  return context.parsed.y.toFixed(4) + ' kW';
                },
                afterLabel: function (context) {
                  return 'Power';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(15, 23, 36, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#667085',
                font: {
                  size: 11
                },
                callback: function (value) {
                  return value + ' kW';
                }
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: false
              },
              ticks: {
                color: '#667085',
                font: {
                  size: 11
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          animation: {
            duration: 1500,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    function triggerDemoAlert(period) {
      if (period === 'fire') {
        // Fire alert demo
        const fireTypes = ['flame', 'smoke', 'flame_and_smoke'];
        const randomType = fireTypes[Math.floor(Math.random() * fireTypes.length)];

        const demoFireAlert = {
          type: randomType,
          flameDetected: randomType !== 'smoke',
          smokeLevel: Math.floor(Math.random() * 600) + 400,
          smokeThreshold: 400,
          timestamp: Date.now()
        };

        const alertId = `demo-fire-${Date.now()}`;
        showFireAlert(demoFireAlert);
        addFireToAlertHistory(demoFireAlert, alertId);
        return;
      }

      let consumption, limit, percentageOver;

      switch (period) {
        case 'hourly':
          limit = 2.0;
          consumption = 2.5 + Math.random() * 0.5; // 2.5-3.0 kWh
          break;
        case 'daily':
          limit = 30.0;
          consumption = 35.0 + Math.random() * 5.0; // 35-40 kWh
          break;
        case 'monthly':
          limit = 500.0;
          consumption = 550.0 + Math.random() * 50.0; // 550-600 kWh
          break;
      }

      percentageOver = parseFloat((((consumption - limit) / limit) * 100).toFixed(2));

      const demoAlert = {
        period: period,
        consumption: consumption,
        limit: limit,
        percentageOver: percentageOver,
        timestamp: Date.now()
      };

      const alertId = `demo-${period}-${Date.now()}`;
      showAlert(demoAlert);
      addToAlertHistory(demoAlert, alertId);
    }


    // Make closeAlert available globally
    window.closeAlert = closeAlert;
    window.setAccountType = setAccountType;

    // Fetch data immediately and every 5 seconds
    $(document).ready(function () {
      fetchSensorData();
      fetchConsumptionAlerts();
      fetchFireAlerts();

      setInterval(fetchSensorData, 5000);
      setInterval(fetchConsumptionAlerts, 3000); // Check for alerts every 3 seconds
      setInterval(fetchFireAlerts, 2000); // Check for fire alerts every 2 seconds
      setInterval(generateAIInsights, 30000); // Update insights every 30 seconds
    });
  </script>



</body>

</html>

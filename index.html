<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="assets/favicon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> <!-- Jquery-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script> <!-- Chart.js -->
  <title>SukatTown</title>
  <style>
    :root {
      --bg: #f6efef;
      --card: #ffffff;
      --muted: #667085;
      --accent-1: #6b53f5;
      --accent-2: #a34ef2;
      --nav-bg: #ffffff;
      --nav-active: rgba(107, 83, 245, 0.12);
      --max-width: 1200px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg, #f6f9fc 0%, var(--bg) 100%);
      color: #0f1724;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 28px;
    }

    .app {
      width: 100%;
      max-width: var(--max-width);
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 18px;
      align-items: start;
    }

    /* LEFT NAV */
    .left-nav {
      background: var(--nav-bg);
      border-radius: 14px;
      padding: 16px 10px;
      box-shadow: 0 6px 20px rgba(12, 18, 30, 0.06);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      height: fit-content;
    }

    .brand {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--accent-2);
      background: linear-gradient(180deg, rgba(163, 78, 242, 0.08), rgba(107, 83, 245, 0.06));
      font-size: 14px;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
      align-items: center;
    }

    .nav button {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .18s;
      color: #555;
    }

    .nav button:hover {
      transform: translateY(-4px);
      color: var(--accent-2)
    }

    .nav button.active {
      background: var(--nav-active);
      color: var(--accent-2);
      box-shadow: inset 0 0 0 1px rgba(107, 83, 245, 0.06);
    }

    .nav .spacer {
      flex: 1
    }

    /* MAIN AREA (topbar + content) */
    .main {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* TOP BAR */
    .topbar {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      border-radius: 12px;
      background: var(--card);
      box-shadow: 0 6px 18px rgba(12, 18, 30, 0.06);
    }

    /* SEARCH (centered visually) */
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .search {
      width: 720px;
      max-width: calc(100% - 120px);
      display: flex;
      align-items: center;
      background: #f9fbff;
      border-radius: 12px;
      padding: 8px 12px;
      border: 1px solid rgba(15, 23, 36, 0.04);
      box-shadow: 0 4px 14px rgba(38, 56, 72, 0.03);
      transition: all 0.5s ease-in-out;
    }

    .search:hover {
      box-shadow: 5px 8px 22px rgba(38, 56, 72, 0.13);
      transform: translateY(1px);
    }

    .search svg {
      width: 18px;
      height: 18px;
      opacity: .7
    }

    .search input {
      border: 0;
      outline: none;
      background: transparent;
      padding: 8px 10px;
      font-size: 15px;
      color: #0f1724;
      flex: 1;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 10px;
      border-radius: 10px;
    }

    .hello {
      font-size: 14px;
      color: var(--muted);
      text-align: right;
    }

    .hello strong {
      display: block;
      font-size: 15px;
      color: #0b1220
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--accent-1), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 6px 18px rgba(163, 78, 242, 0.16);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-badge.offline {
      background: #ffebee;
      color: #c62828;
    }

    /* GRID CONTENT: left big area (cards) + right side column */
    .grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 20px;
      align-items: start;
    }

    /* All cards */
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(12, 18, 30, 0.06);
      transition: all 0.4s ease-in-out;
    }

    .card:hover {
      box-shadow: 0 12px 28px rgba(12, 18, 30, 0.12);
      transform: translateY(-2px);
    }

    /* Top cards like reference */
    .cards-top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }

    .big-tile {
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      justify-content: space-between;
    }

    .consumption-tile {
      background: linear-gradient(135deg, #6b9bf6, #4f6df0);
      color: white;
    }

    .power-tile {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }

    .tile-title {
      font-weight: 700;
      font-size: 14px;
      opacity: 0.95
    }

    .tile-value {
      font-size: 32px;
      font-weight: 800;
      margin-top: 6px
    }

    .tile-sub {
      font-size: 13px;
      opacity: 0.95;
    }

    /* usage trend card */
    .usage {
      margin-top: 8px;
    }

    .mini-cards {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .mini {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      flex: 1;
      border: 1px solid rgba(15, 23, 36, 0.04);
      text-align: center;
    }

    .mini p {
      margin: 0;
      font-size: 13px;
      color: var(--muted)
    }

    .mini strong {
      display: block;
      margin-top: 6px;
      font-size: 16px
    }

    /* RIGHT SIDEBAR cards */
    .side-col {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .prediction {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pred-row {
      display: flex;
      gap: 10px;
    }

    .small-card {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid rgba(15, 23, 36, 0.03);
    }

    /* footer / notes */
    .note {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px
    }

    /* Alert notification styles */
    .alert-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .alert-notification {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 18px 20px;
      border-radius: 14px;
      box-shadow: 0 10px 40px rgba(238, 90, 82, 0.4);
      display: flex;
      align-items: flex-start;
      gap: 14px;
      animation: slideIn 0.4s ease-out;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .alert-notification.warning {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      box-shadow: 0 10px 40px rgba(251, 191, 36, 0.4);
    }

    .alert-notification.info {
      background: linear-gradient(135deg, #6b9bf6, #4f6df0);
      box-shadow: 0 10px 40px rgba(107, 155, 246, 0.4);
    }

    .alert-icon {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 8px;
      font-size: 18px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .alert-message {
      font-size: 13px;
      opacity: 0.95;
      line-height: 1.4;
    }

    .alert-time {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .alert-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 4px;
      opacity: 0.8;
      transition: opacity 0.2s;
      font-size: 20px;
      line-height: 1;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .alert-close:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .alert-notification.removing {
      animation: slideOut 0.3s ease-in forwards;
    }

    /* Alert history section */
    .alert-history {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .alert-history-item {
      background: rgba(255, 107, 107, 0.08);
      border-left: 3px solid #ff6b6b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .alert-history-item.warning {
      background: rgba(251, 191, 36, 0.08);
      border-left-color: #fbbf24;
    }

    .alert-history-item-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .alert-history-item-message {
      color: var(--muted);
      font-size: 12px;
    }

    .alert-history-item-time {
      color: var(--muted);
      font-size: 11px;
      margin-top: 4px;
    }

    /* responsive */
    @media (max-width: 980px) {
      .app {
        grid-template-columns: 60px 1fr;
        gap: 12px;
      }

      .search {
        width: 100%;
        max-width: 520px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .topbar {
        grid-template-columns: 1fr;
        row-gap: 10px;
        align-items: center;
      }

      .topbar-right {
        justify-self: end;
      }

      .alert-container {
        max-width: 90%;
        right: 5%;
      }
    }

    @media (max-width:560px) {
      body {
        padding: 16px
      }

      .left-nav {
        display: none
      }

      .app {
        grid-template-columns: 1fr;
      }

      .search {
        max-width: 100%
      }

      .alert-container {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: calc(100% - 20px);
      }
    }
  </style>
</head>

<body>
  <!-- Alert notification container -->
  <div class="alert-container" id="alertContainer"></div>

  <div class="app">

    <!-- LEFT NAV -->
    <aside class="left-nav" aria-hidden="true">
      <div class="brand">EL</div>

      <div class="nav" role="navigation" aria-label="Main">
        <button class="active" title="Dashboard" aria-label="Dashboard">
          <!-- home icon -->
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M3 10.5L12 4l9 6.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V10.5z" />
          </svg>
        </button>

        <button title="Consumption" aria-label="Consumption">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M12 2v10l3-2 2 2 3-5V2h-8zM4 11h6v11H4z" />
          </svg>
        </button>

        <button title="Reports" aria-label="Reports">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M3 5v14h18V5H3zm2 2h14v10H5V7z" />
          </svg>
        </button>

        <button title="Settings" aria-label="Settings">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path
              d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm9.4 6.5a8.1 8.1 0 0 0 0-2.9l2-1.4-2-3.5-2.3.6a7.9 7.9 0 0 0-2.5-1.4L13.2 3h-2.4l-.4 2.9a8 8 0 0 0-2.5 1.4L5.6 6.7 3.6 10l2 1.4a8 8 0 0 0 0 2.9L3.6 15.7 5.6 19l2.3-.6c.8.6 1.7 1 2.6 1.4l.4 2.9h2.4l.4-2.9c.9-.4 1.8-.8 2.6-1.4l2.3.6 2-3.4-2-1.4z" />
          </svg>
        </button>

        <div class="spacer" aria-hidden="true"></div>

        <button title="Help" aria-label="Help">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path
              d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 15h-2v-2h2v2zm1.1-7.8c-.2.7-.9 1.3-1.1 1.6-.3.3-.5.6-.5 1.2v.5h-2v-.7c0-.9.4-1.5.8-1.9.5-.5 1.2-1.1 1.2-1.9 0-.8-.6-1.4-1.4-1.4-.8 0-1.4.6-1.4 1.4H9c0-1.9 1.5-3.4 3.4-3.4S15 7.9 15 9.1c0 .4-.2.9-.9 1.5z" />
          </svg>
        </button>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main">

      <!-- TOPBAR: search + profile -->
      <div class="topbar" role="banner">
        <div class="search-wrap" aria-hidden="false">
          <div style="font-weight:700;color:#10213a">SukatTown</div>
          <span class="status-badge" id="connectionStatus">‚óè Connecting...</span>
        </div>

        <div style="display:flex;align-items:center;gap:16px;justify-self:end">
          <div class="search" role="search" aria-label="Search">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" />
            </svg>
            <input id="topSearch" type="search" placeholder="Search anything..." aria-label="Search anything" />
          </div>

          <!-- PROFILE / GREETING on upper-right -->
          <div class="topbar-right">
            <div class="profile" title="Account">
              <div class="hello">
                <span style="font-size:13px;color:var(--muted)">Hello,</span>
                <strong>New User</strong>
              </div>
              <div class="avatar" aria-hidden="true">NU</div>
            </div>
          </div>
        </div>
      </div>

      <!-- GRID: main cards + right column -->
      <div class="grid">

        <!-- LEFT: main cards -->
        <div>

          <!-- top two tiles -->
          <div class="cards-top">
            <div class="card big-tile consumption-tile">
              <div>
                <div class="tile-title">Today's Consumption</div>
                <div class="tile-value" id="consumptionValue">22 kWh</div>
                <div class="tile-sub">Current usage ‚Ä¢ Real-time ESP32 data</div>
              </div>

              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
                <div style="font-size:13px;opacity:.95">Peak: <strong id="peakValue">35 kWh</strong></div>
                <div style="font-size:13px;opacity:.95">Avg: <strong id="avgValue">18 kWh</strong></div>
                <div style="font-size:13px;opacity:.95">Cost est.: <strong id="costValue">‚Ç±120.50</strong></div>
              </div>
            </div>

            <div class="card big-tile power-tile">
              <div>
                <div class="tile-title">Voltage Stability</div>
                <div class="tile-value" id="voltageValue">230 V</div>
                <div class="tile-sub">Nominal voltage ‚Ä¢ RMS</div>
              </div>

              <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:6px">
                <div style="text-align:right;font-size:13px">Frequency: <strong id="frequencyValue">60 Hz</strong></div>
                <div style="text-align:right;font-size:13px">PF: <strong id="pfValue">0.95</strong></div>
              </div>
            </div>
          </div>

          <!-- Usage trend / mini cards -->
          <div class="card usage">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">How's the consumption today?</div>
              <div style="color:var(--muted);font-size:13px">Realtime ‚Ä¢ Live Data</div>
            </div>

            <!-- Chart.js consumption graph -->
            <div style="margin-top:12px;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px">
              <canvas id="consumptionChart" height="96"></canvas>
            </div>

            <div class="mini-cards">
              <div class="mini">
                <p id="period1Label">Morning</p>
                <strong id="period1Value">5 kWh</strong>
              </div>
              <div class="mini">
                <p id="period2Label">Afternoon</p>
                <strong id="period2Value">10 kWh</strong>
              </div>
              <div class="mini">
                <p id="period3Label">Evening</p>
                <strong id="period3Value">7 kWh</strong>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: side column -->
        <aside class="side-col">

          <div class="card small-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-weight:700">Summary</div>
                <div style="color:var(--muted);font-size:13px;margin-top:6px">Total today</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:20px;font-weight:800" id="summaryEnergy">22 kWh</div>
                <div style="font-size:13px;color:var(--muted)" id="lastUpdate">Peak 6:00 PM</div>
              </div>
            </div>

            <div class="note">Based on real-time meter readings from ESP32 via Node.js backend.</div>
          </div>

          <div class="card small-card prediction">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Real-time Values</div>
              <div style="color:var(--muted);font-size:13px">Live</div>
            </div>

            <div class="pred-row">
              <div
                style="flex:1;background:#fff;border-radius:10px;padding:10px;border:1px solid rgba(15,23,36,0.03);text-align:center">
                <div style="font-size:13px;color:var(--muted)">Voltage</div>
                <div style="font-weight:800;margin-top:6px" id="sideVoltage">230 V</div>
              </div>
              <div
                style="flex:1;background:#fff;border-radius:10px;padding:10px;border:1px solid rgba(15,23,36,0.03);text-align:center">
                <div style="font-size:13px;color:var(--muted)">Current</div>
                <div style="font-weight:800;margin-top:6px" id="sideCurrent">5 A</div>
              </div>
            </div>

            <div style="margin-top:10px" class="note">Receiving live data from ESP32...</div>
          </div>


          <!-- Alert History Card -->
          <div class="card small-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Alert History</div>
              <div style="color:var(--muted);font-size:13px" id="alertCount">0 alerts</div>
            </div>
            <div class="alert-history" id="alertHistory">
              <div class="note" style="margin-top:10px;text-align:center">No alerts yet</div>
            </div>
          </div>

          <!-- Demo Alert Triggers -->
          <div class="card small-card">
            <div style="font-weight:700;margin-bottom:12px">Demo Controls</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button onclick="triggerDemoAlert('hourly')"
                style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ‚ö° Trigger Hourly Alert
              </button>
              <button onclick="triggerDemoAlert('daily')"
                style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                üö® Trigger Daily Alert
              </button>
              <button onclick="triggerDemoAlert('monthly')"
                style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#a34ef2,#6b53f5);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                üìà Trigger Monthly Alert
              </button>
              <button onclick="triggerDemoAlert('fire')"
                style="padding:10px;border-radius:8px;border:none;background:linear-gradient(135deg,#ff4444,#cc0000);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                üî• Trigger Fire Alert
              </button>
            </div>
            <div class="note" style="margin-top:10px">Click buttons to test alert notifications</div>
          </div>

        </aside>

      </div> <!-- end grid -->
    </div> <!-- end main -->
  </div> <!-- end app -->


  <script>
    // Live data fetching from Node.js backend
    let chartInstance = null;
    let sensorHistory = [];
    const API_URL = 'https://sukattown-backend.onrender.com/api/power-data';
    const ALERT_API_URL = 'https://sukattown-backend.onrender.com/api/consumption-alerts';
    const FIRE_ALERT_API_URL = 'https://sukattown-backend.onrender.com/api/fire-alerts'; // ADD THIS
    const COST_PER_KWH = 5.5;
    let alertHistory = [];
    let lastAlertCheck = 0;

    function fetchSensorData() {
      fetch(API_URL)
        .then(response => response.json())
        .then(data => {
          console.log('Fetched data:', data);
          updateDashboard(data);
          updateConnectionStatus(true);

          sensorHistory.push({
            timestamp: new Date(),
            power: data.power || 0,
            energy: data.energy || 0
          });

          if (sensorHistory.length > 50) {
            sensorHistory.shift();
          }

          updateChart();
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          updateConnectionStatus(false);
        });
    }

    function fetchConsumptionAlerts() {
      const now = Date.now();
      if (now - lastAlertCheck < 5000) return; // Check every 5 seconds minimum

      lastAlertCheck = now;

      fetch(ALERT_API_URL)
        .then(response => response.json())
        .then(data => {
          if (data && data.period) {
            const alertId = `${data.period}-${data.timestamp}`;

            // Check if this alert was already shown
            const existingAlert = alertHistory.find(a => a.id === alertId);
            if (!existingAlert) {
              showAlert(data);
              addToAlertHistory(data, alertId);
            }
          }
        })
        .catch(error => {
          console.error('Error fetching alerts:', error);
        });
    }

    function fetchFireAlerts() {
      fetch(FIRE_ALERT_API_URL)
        .then(response => {
          if (!response.ok) {
            if (response.status === 404) {
              return null;
            }
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data && data.type) {
            const alertId = `fire-${data.timestamp}`;

            const existingAlert = alertHistory.find(a => a.id === alertId);
            if (!existingAlert) {
              showFireAlert(data);
              addFireToAlertHistory(data, alertId);
            }
          }
        })
        .catch(error => {
          // Silently handle errors
        });
    }

    function showAlert(alertData) {
      const container = $('#alertContainer');
      const alertId = `alert-${Date.now()}`;

      let title, message, icon, type;

      switch (alertData.period) {
        case 'hourly':
          title = '‚ö†Ô∏è Hourly Limit Exceeded';
          message = `Consumption: ${alertData.consumption.toFixed(2)} kWh (Limit: ${alertData.limit} kWh) - ${alertData.percentageOver}% over`;
          icon = '‚ö°';
          type = 'warning';
          break;
        case 'daily':
          title = 'üö® Daily Limit Exceeded';
          message = `Consumption: ${alertData.consumption.toFixed(2)} kWh (Limit: ${alertData.limit} kWh) - ${alertData.percentageOver}% over`;
          icon = 'üìä';
          type = '';
          break;
        case 'monthly':
          title = 'üî¥ Monthly Limit Exceeded';
          message = `Consumption: ${alertData.consumption.toFixed(2)} kWh (Limit: ${alertData.limit} kWh) - ${alertData.percentageOver}% over`;
          icon = 'üìà';
          type = 'info';
          break;
        default:
          title = 'Alert';
          message = 'Energy consumption threshold exceeded';
          icon = '‚ö†Ô∏è';
          type = 'info';
      }

      const alertHtml = `
        <div class="alert-notification ${type}" id="${alertId}">
          <div class="alert-icon">${icon}</div>
          <div class="alert-content">
            <div class="alert-title">${title}</div>
            <div class="alert-message">${message}</div>
            <div class="alert-time">${new Date().toLocaleTimeString()}</div>
          </div>
          <button class="alert-close" onclick="closeAlert('${alertId}')">√ó</button>
        </div>
      `;

      container.append(alertHtml);

      // Play sound notification (optional)
      playAlertSound();

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        closeAlert(alertId);
      }, 10000);
    }

    function showFireAlert(alertData) {
      const container = $('#alertContainer');
      const alertId = `alert-${Date.now()}`;

      let message = '';
      if (alertData.type === 'flame_and_smoke') {
        message = `‚ö†Ô∏è CRITICAL: Flame and smoke detected! Smoke level: ${alertData.smokeLevel}`;
      } else if (alertData.type === 'flame') {
        message = `üî• Flame detected!`;
      } else if (alertData.type === 'smoke') {
        message = `üí® Smoke detected! Level: ${alertData.smokeLevel} (Threshold: ${alertData.smokeThreshold})`;
      }

      const alertHtml = `
    <div class="alert-notification" id="${alertId}" style="background:linear-gradient(135deg,#ff4444,#cc0000)">
      <div class="alert-icon">üî•</div>
      <div class="alert-content">
        <div class="alert-title">üö® FIRE ALARM!</div>
        <div class="alert-message">${message}</div>
        <div class="alert-time">${new Date().toLocaleTimeString()}</div>
      </div>
      <button class="alert-close" onclick="closeAlert('${alertId}')">√ó</button>
    </div>
  `;

      container.append(alertHtml);

      // Play urgent alarm sound
      playFireAlarmSound();

      // Auto-dismiss after 15 seconds (longer for fire alerts)
      setTimeout(() => {
        closeAlert(alertId);
      }, 15000);
    }

    function playFireAlarmSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Create urgent pulsing alarm sound
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 1200; // Higher frequency for urgency
            oscillator.type = 'square'; // Harsher sound for alarm

            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
          }, i * 600);
        }
      } catch (error) {
        console.log('Audio notification not available');
      }
    }

    function addFireToAlertHistory(alertData, alertId) {
      const historyItem = {
        id: alertId,
        period: 'fire',
        type: alertData.type,
        flameDetected: alertData.flameDetected,
        smokeLevel: alertData.smokeLevel,
        timestamp: new Date()
      };

      alertHistory.unshift(historyItem);

      if (alertHistory.length > 10) {
        alertHistory.pop();
      }

      updateAlertHistory();
    }

    function closeAlert(alertId) {
      const alert = $(`#${alertId}`);
      alert.addClass('removing');
      setTimeout(() => {
        alert.remove();
      }, 300);
    }

    function addToAlertHistory(alertData, alertId) {
      const historyItem = {
        id: alertId,
        period: alertData.period,
        consumption: alertData.consumption,
        limit: alertData.limit,
        percentageOver: alertData.percentageOver,
        timestamp: new Date()
      };

      alertHistory.unshift(historyItem);

      // Keep only last 10 alerts
      if (alertHistory.length > 10) {
        alertHistory.pop();
      }

      updateAlertHistory();
    }

    function updateAlertHistory() {
      const historyContainer = $('#alertHistory');
      $('#alertCount').text(`${alertHistory.length} alert${alertHistory.length !== 1 ? 's' : ''}`);

      if (alertHistory.length === 0) {
        historyContainer.html('<div class="note" style="margin-top:10px;text-align:center">No alerts yet</div>');
        return;
      }

      let historyHtml = '';
      alertHistory.forEach(alert => {
        const typeClass = alert.period === 'hourly' ? 'warning' : '';
        const icon = alert.period === 'hourly' ? '‚ö°' : alert.period === 'daily' ? 'üìä' : 'üìà';

        historyHtml += `
          <div class="alert-history-item ${typeClass}">
            <div class="alert-history-item-title">${icon} ${alert.period.charAt(0).toUpperCase() + alert.period.slice(1)} Alert</div>
            <div class="alert-history-item-message">
              ${alert.consumption.toFixed(2)} kWh consumed (${alert.percentageOver.toFixed(1)}% over ${alert.limit} kWh limit)
            </div>
            <div class="alert-history-item-time">${alert.timestamp.toLocaleString()}</div>
          </div>
        `;
      });

      historyContainer.html(historyHtml);
    }

    function playAlertSound() {
      // Create a simple beep sound using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.frequency.value = 800;
        oscillator.type = 'sine';

        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (error) {
        console.log('Audio notification not available');
      }
    }

    function updateDashboard(data) {
      const voltage = data.voltage || 0;
      const current = data.current || 0;
      const power = data.power || 0;
      const energy = data.energy || 0;
      const frequency = data.frequency || 0;
      const pf = data.powerFactor || 0;
      const cost = (energy * COST_PER_KWH).toFixed(2);

      // Update main tiles
      $('#consumptionValue').text(energy.toFixed(2) + ' kWh');
      $('#voltageValue').text(voltage.toFixed(1) + ' V');
      $('#frequencyValue').text(frequency.toFixed(1) + ' Hz');
      $('#pfValue').text(pf.toFixed(2));
      $('#costValue').text('‚Ç±' + cost);

      // Calculate period values based on current time and sensor history
      updatePeriodValues();

      // Update side panel
      $('#summaryEnergy').text(energy.toFixed(2) + ' kWh');
      $('#sideVoltage').text(voltage.toFixed(1) + ' V');
      $('#sideCurrent').text(current.toFixed(2) + ' A');
      $('#lastUpdate').text('Updated: ' + new Date().toLocaleTimeString());
    }

    function updatePeriodValues() {
      const now = new Date();
      const hour = now.getHours();

      // Get total accumulated energy for each period
      const morningData = sensorHistory.filter(d => new Date(d.timestamp).getHours() >= 6 && new Date(d.timestamp).getHours() < 12);
      const afternoonData = sensorHistory.filter(d => new Date(d.timestamp).getHours() >= 12 && new Date(d.timestamp).getHours() < 17);
      const eveningData = sensorHistory.filter(d => new Date(d.timestamp).getHours() >= 17 && new Date(d.timestamp).getHours() < 22);

      const morningEnergy = morningData.length > 0 ? morningData[morningData.length - 1].energy || 0 : 0;
      const afternoonEnergy = afternoonData.length > 0 ? afternoonData[afternoonData.length - 1].energy || 0 : 0;
      const eveningEnergy = eveningData.length > 0 ? eveningData[eveningData.length - 1].energy || 0 : 0;

      // Update display with values
      $('#period1Label').text(hour >= 6 && hour < 12 ? 'Morning (Now)' : 'Morning');
      $('#period1Value').text(morningEnergy.toFixed(2) + ' kWh');

      $('#period2Label').text(hour >= 12 && hour < 17 ? 'Afternoon (Now)' : 'Afternoon');
      $('#period2Value').text(afternoonEnergy.toFixed(2) + ' kWh');

      $('#period3Label').text(hour >= 17 && hour < 22 ? 'Evening (Now)' : 'Evening');
      $('#period3Value').text(eveningEnergy.toFixed(2) + ' kWh');
    }

    function updateConnectionStatus(connected) {
      const badge = $('#connectionStatus');
      if (connected) {
        badge.removeClass('offline').text('‚óè Connected');
      } else {
        badge.addClass('offline').text('‚óè Offline');
      }
    }

    function updateChart() {
      if (sensorHistory.length === 0) return;

      const labels = sensorHistory.map(d => {
        const time = new Date(d.timestamp);
        return time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      });
      const powerData = sensorHistory.map(d => d.power / 1000);

      if (chartInstance) {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = powerData;
        chartInstance.update('none');
      } else {
        initChart(labels, powerData);
      }
    }


    // Chart.js integration (cannot be converted to jQuery)
    function initChart(labels, data) {
      const ctx = document.getElementById('consumptionChart').getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 0, 96);
      gradient.addColorStop(0, 'rgba(107, 83, 245, 0.3)');
      gradient.addColorStop(1, 'rgba(107, 83, 245, 0.01)');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Power (kW)',
            data: data,
            borderColor: '#6b53f5',
            backgroundColor: gradient,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#6b53f5',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#6b53f5',
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(255, 255, 255, 0.98)',
              titleColor: '#0f1724',
              bodyColor: '#6b53f5',
              borderColor: 'rgba(107, 83, 245, 0.2)',
              borderWidth: 2,
              padding: 16,
              borderRadius: 12,
              titleFont: {
                size: 12,
                weight: '600',
                family: 'Inter, sans-serif'
              },
              bodyFont: {
                size: 18,
                weight: '800',
                family: 'Inter, sans-serif'
              },
              displayColors: false,
              caretSize: 8,
              caretPadding: 10,
              callbacks: {
                title: function (context) {
                  return context[0].label;
                },
                label: function (context) {
                  return context.parsed.y.toFixed(4) + ' kW';
                },
                afterLabel: function (context) {
                  return 'Power';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(15, 23, 36, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#667085',
                font: {
                  size: 11
                },
                callback: function (value) {
                  return value + ' kW';
                }
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: false
              },
              ticks: {
                color: '#667085',
                font: {
                  size: 11
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          animation: {
            duration: 1500,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    function triggerDemoAlert(period) {
      if (period === 'fire') {
        // Fire alert demo
        const fireTypes = ['flame', 'smoke', 'flame_and_smoke'];
        const randomType = fireTypes[Math.floor(Math.random() * fireTypes.length)];

        const demoFireAlert = {
          type: randomType,
          flameDetected: randomType !== 'smoke',
          smokeLevel: Math.floor(Math.random() * 600) + 400,
          smokeThreshold: 400,
          timestamp: Date.now()
        };

        const alertId = `demo-fire-${Date.now()}`;
        showFireAlert(demoFireAlert);
        addFireToAlertHistory(demoFireAlert, alertId);
        return;
      }

      let consumption, limit, percentageOver;

      switch (period) {
        case 'hourly':
          limit = 2.0;
          consumption = 2.5 + Math.random() * 0.5; // 2.5-3.0 kWh
          break;
        case 'daily':
          limit = 30.0;
          consumption = 35.0 + Math.random() * 5.0; // 35-40 kWh
          break;
        case 'monthly':
          limit = 500.0;
          consumption = 550.0 + Math.random() * 50.0; // 550-600 kWh
          break;
      }

      percentageOver = parseFloat((((consumption - limit) / limit) * 100).toFixed(2));

      const demoAlert = {
        period: period,
        consumption: consumption,
        limit: limit,
        percentageOver: percentageOver,
        timestamp: Date.now()
      };

      const alertId = `demo-${period}-${Date.now()}`;
      showAlert(demoAlert);
      addToAlertHistory(demoAlert, alertId);
    }


    // Make closeAlert available globally
    window.closeAlert = closeAlert;

    // Fetch data immediately and every 5 seconds
    $(document).ready(function () {
      fetchSensorData();
      fetchConsumptionAlerts();
      fetchFireAlerts();

      setInterval(fetchSensorData, 5000);
      setInterval(fetchConsumptionAlerts, 3000); // Check for alerts every 3 seconds
      setInterval(fetchFireAlerts, 2000); // Check for fire alerts every 3 seconds
    });
  </script>

</body>

</html>